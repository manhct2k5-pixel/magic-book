<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hợp đồng tình yêu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;600&family=Cormorant+Garamond:wght@400;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --rose-50: #fff7f2;
            --rose-100: #f9efe9;
            --rose-200: #f6d8d2;
            --rose-300: #f3c9c1;
            --gold-200: #f7e3bd;
            --gold-300: #f2d6a3;
            --gold-500: #d8b56c;
            --wine-900: #2b0e13;
            --wine-800: #3b1219;
            --wine-700: #5c1a23;
            --wine-600: #7a2430;
            --ink-900: #2b1417;
            --ink-800: #3b1a1f;
            --glass: rgba(255, 244, 235, 0.12);
            --glow: rgba(242, 214, 163, 0.4);
        }

        * { box-sizing: border-box; }

        body { 
            margin: 0; 
            overflow-x: hidden;
            overflow-y: auto;
            min-height: 100vh;
            position: relative;
            background:
                radial-gradient(1100px 800px at 15% 12%, rgba(255, 240, 230, 0.28), transparent 60%),
                radial-gradient(900px 650px at 90% 88%, rgba(255, 204, 213, 0.22), transparent 60%),
                linear-gradient(180deg, #6b1d28 0%, #351016 50%, #14070a 100%);
            font-family: "Be Vietnam Pro", sans-serif; 
            color: var(--rose-100);
        }

        body::before,
        body::after {
            content: "";
            position: fixed;
            inset: -15%;
            pointer-events: none;
            z-index: 1;
            mix-blend-mode: screen;
            animation: floatGlow 18s ease-in-out infinite;
        }

        body::before {
            background:
                radial-gradient(520px 380px at 20% 20%, rgba(255, 229, 213, 0.42), transparent 60%),
                radial-gradient(760px 520px at 80% 70%, rgba(255, 198, 210, 0.3), transparent 65%);
            opacity: 0.55;
        }

        body::after {
            background:
                radial-gradient(520px 420px at 70% 15%, rgba(255, 230, 219, 0.28), transparent 60%),
                radial-gradient(620px 520px at 15% 80%, rgba(242, 214, 163, 0.25), transparent 65%);
            opacity: 0.45;
            animation-delay: -9s;
        }
        
        #vignette {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background:
                radial-gradient(circle at 50% 38%, rgba(255, 246, 235, 0.22) 0%, rgba(55, 18, 24, 0.66) 58%, rgba(8, 3, 5, 0.92) 100%);
            pointer-events: none; z-index: 5;
        }

        #noise {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image:
                radial-gradient(circle at 20% 20%, rgba(255, 214, 198, 0.08), transparent 45%),
                radial-gradient(circle at 80% 30%, rgba(255, 206, 216, 0.08), transparent 45%),
                url('https://grainy-gradients.vercel.app/noise.svg');
            opacity: 0.08; pointer-events: none; z-index: 6;
            filter: contrast(160%);
            mix-blend-mode: soft-light;
        }

        #frame {
            position: fixed;
            inset: 18px;
            border-radius: 28px;
            border: 1px solid rgba(216, 181, 108, 0.5);
            box-shadow:
                inset 0 0 0 1px rgba(255, 255, 255, 0.08),
                0 12px 30px rgba(0, 0, 0, 0.35);
            pointer-events: none;
            z-index: 7;
        }

        #frame::before {
            content: "";
            position: absolute;
            inset: 10px;
            border-radius: 22px;
            border: 1px dashed rgba(242, 214, 163, 0.25);
        }

        #frame::after {
            content: "";
            position: absolute;
            inset: -6px;
            border-radius: 32px;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        #ui {
            position: absolute; top: 26px; left: 50%; transform: translate(-50%, 0);
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            padding: 16px 36px 14px; text-align: center; pointer-events: none;
            background: linear-gradient(135deg, rgba(255, 250, 242, 0.2), rgba(121, 30, 38, 0.35));
            border: 1px solid rgba(216, 181, 108, 0.6);
            border-radius: 999px; backdrop-filter: blur(10px);
            box-shadow: 0 14px 30px rgba(15, 5, 8, 0.45);
            z-index: 20;
            animation: fadeDown 1.4s ease both;
        }

        #ui::before {
            content: "";
            position: absolute;
            inset: 6px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        #ui::after {
            content: "";
            position: absolute;
            top: -8px;
            left: 50%;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 243, 211, 0.9) 0%, rgba(216, 181, 108, 0.9) 55%, transparent 70%);
            transform: translateX(-50%);
            filter: drop-shadow(0 0 10px rgba(242, 214, 163, 0.6));
        }

        #ui .ui-title {
            font-family: "Cormorant Garamond", "Playfair Display", serif;
            font-size: 22px; letter-spacing: 0.2em; text-transform: uppercase;
            color: var(--gold-200);
        }

        #ui .ui-subtitle {
            font-size: clamp(20px, 3vw, 30px);
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: rgba(242, 214, 163, 0.95);
        }
        #ui .ui-subtitle.large {
            letter-spacing: 0.32em;
        }

        #credit {
            position: absolute; bottom: 18px; right: 22px;
            color: rgba(255, 232, 198, 0.7);
            font-family: "Be Vietnam Pro", sans-serif;
            font-size: 9px; letter-spacing: 0.26em; text-transform: uppercase;
            z-index: 100; opacity: 0.85; pointer-events: none;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #subtitle-container {
            width: 100%;
            display: flex;
            justify-content: center;
            pointer-events: none;
            z-index: 20;
            padding: 0 18px;
            margin-top: 8px;
        }

        #subtitle {
            position: relative;
            font-family: "Be Vietnam Pro", sans-serif;
            font-weight: 500;
            color: var(--ink-800); 
            background: linear-gradient(140deg, rgba(255, 251, 245, 0.98), rgba(255, 230, 228, 0.92));
            border: 1px solid rgba(216, 181, 108, 0.7);
            border-radius: 22px;
            box-shadow: 0 18px 36px rgba(28, 10, 13, 0.4), inset 0 0 0 1px rgba(255, 255, 255, 0.5);
            padding: 22px 46px;
            backdrop-filter: blur(10px);
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease;
            max-width: min(84%, 860px);
            text-align: center;
            line-height: 1.55;
            display: grid;
            gap: 6px;
            justify-items: center;
        }

        #subtitle.show {
            opacity: 1;
            transform: translateY(0);
        }

        #chapter-kicker {
            font-size: 10px;
            letter-spacing: 0.32em;
            text-transform: uppercase;
            color: rgba(90, 28, 36, 0.7);
        }

        #chapter-title {
            font-family: "Cormorant Garamond", "Playfair Display", serif;
            font-size: clamp(22px, 3.2vw, 34px);
            font-weight: 700;
            color: #4a121a;
        }

        #chapter-line {
            font-size: clamp(16px, 2.2vw, 24px);
            font-style: italic;
            color: #3b1a1f;
            opacity: 0;
            transform: translateY(6px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            min-height: 1.6em;
        }

        #chapter-line.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        #subtitle::before,
        #subtitle::after {
            content: "";
            position: absolute;
            top: 50%;
            width: 10px; height: 10px;
            background: radial-gradient(circle, #f7e3bd 0%, #d8b56c 60%, rgba(216, 181, 108, 0) 70%);
            border-radius: 50%;
            box-shadow: 0 0 12px var(--glow);
            transform: translateY(-50%);
        }

        #subtitle::before { left: 16px; }
        #subtitle::after { right: 16px; }

        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background:
                radial-gradient(600px 420px at 50% 35%, rgba(255, 232, 214, 0.2), transparent 65%),
                linear-gradient(180deg, #2b0f14 0%, #120608 100%);
            color: var(--gold-300); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s;
            gap: 12px;
            overflow: hidden;
            font-family: "Cormorant Garamond", "Playfair Display", serif;
        }

        #intro-screen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            background:
                radial-gradient(680px 460px at 50% 35%, rgba(255, 234, 214, 0.18), transparent 70%),
                linear-gradient(180deg, rgba(40, 12, 16, 0.96) 0%, rgba(12, 4, 6, 0.98) 100%);
            z-index: 9500;
            transition: opacity 0.6s ease;
        }

        #intro-screen.is-hidden {
            opacity: 0;
            pointer-events: none;
        }

        #intro-card {
            width: min(90vw, 640px);
            padding: 28px 30px 26px;
            background: linear-gradient(140deg, rgba(255, 250, 242, 0.98), rgba(255, 232, 224, 0.92));
            border-radius: 24px;
            border: 1px solid rgba(216, 181, 108, 0.7);
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.4);
            text-align: center;
            color: #3b1a1f;
        }

        #intro-card .intro-eyebrow {
            font-size: 10px;
            letter-spacing: 0.32em;
            text-transform: uppercase;
            color: rgba(90, 28, 36, 0.6);
        }

        #intro-card h1 {
            font-family: "Cormorant Garamond", "Playfair Display", serif;
            font-size: clamp(24px, 3.2vw, 36px);
            margin: 10px 0 12px;
        }

        #intro-card p {
            font-size: clamp(15px, 2.2vw, 20px);
            line-height: 1.6;
            margin: 0 0 18px;
        }

        .intro-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .intro-btn {
            min-width: 140px;
            padding: 10px 20px;
            border-radius: 999px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        }

        #intro-yes {
            background: linear-gradient(135deg, #f7e3bd, #d8b56c);
            color: #3b1a1f;
            box-shadow: 0 10px 18px rgba(216, 181, 108, 0.45);
        }

        #intro-no {
            background: rgba(87, 24, 32, 0.9);
            color: #fff;
            box-shadow: 0 10px 18px rgba(30, 8, 12, 0.35);
            transform-origin: center;
        }

        #letter-modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: rgba(10, 3, 5, 0.82);
            backdrop-filter: blur(8px);
            z-index: 9800;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        #letter-modal.is-visible {
            opacity: 1;
            pointer-events: auto;
        }

        #letter-card {
            position: relative;
            width: min(92vw, 760px);
            max-height: 82vh;
            overflow-y: auto;
            padding: 30px 30px 34px;
            background:
                linear-gradient(180deg, rgba(255, 251, 244, 0.98) 0%, rgba(249, 237, 228, 0.98) 100%),
                repeating-linear-gradient(180deg, rgba(216, 181, 108, 0.06) 0px, rgba(216, 181, 108, 0.06) 1px, transparent 1px, transparent 24px);
            border-radius: 26px;
            border: 1px solid rgba(216, 181, 108, 0.75);
            box-shadow: 0 26px 52px rgba(0, 0, 0, 0.45);
            color: #3b1a1f;
        }

        #letter-card::before {
            content: "";
            position: absolute;
            inset: 12px;
            border-radius: 20px;
            border: 1px dashed rgba(122, 36, 48, 0.25);
            pointer-events: none;
        }

        #letter-card::-webkit-scrollbar { width: 6px; }
        #letter-card::-webkit-scrollbar-thumb {
            background: rgba(216, 181, 108, 0.6);
            border-radius: 999px;
        }
        #letter-card::-webkit-scrollbar-track { background: transparent; }

        #letter-close {
            position: absolute;
            top: 18px;
            right: 20px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: rgba(87, 24, 32, 0.92);
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }

        .letter-header {
            text-align: center;
            margin-bottom: 16px;
            position: relative;
            z-index: 1;
        }

        .letter-eyebrow {
            font-size: 10px;
            letter-spacing: 0.32em;
            text-transform: uppercase;
            color: rgba(90, 28, 36, 0.6);
        }

        .letter-title {
            font-family: "Cormorant Garamond", "Playfair Display", serif;
            font-size: clamp(22px, 3vw, 34px);
            margin: 8px 0 6px;
            color: #5c1a23;
        }

        .letter-divider {
            width: 140px;
            height: 2px;
            margin: 0 auto;
            background: linear-gradient(90deg, transparent, rgba(216, 181, 108, 0.8), transparent);
        }

        .letter-body {
            font-family: "Be Vietnam Pro", sans-serif;
            font-size: clamp(15px, 2.2vw, 19px);
            line-height: 1.7;
            position: relative;
            z-index: 1;
        }

        .letter-body p { margin: 0 0 14px; }
        .letter-body strong { color: #7a2430; }
        .letter-body ul { padding-left: 20px; margin: 0 0 16px; }
        .letter-body li { margin-bottom: 8px; }
        .letter-sign {
            text-align: right;
            margin-top: 18px;
            font-weight: 700;
            font-family: "Cormorant Garamond", "Playfair Display", serif;
            font-size: clamp(16px, 2.4vw, 20px);
        }

        #loading-screen::before,
        #loading-screen::after {
            content: "";
            position: absolute;
            width: 320px; height: 320px;
            border-radius: 50%;
            border: 1px solid rgba(216, 181, 108, 0.35);
            box-shadow: 0 0 30px rgba(216, 181, 108, 0.2);
        }

        #loading-screen::before { opacity: 0.5; transform: translateY(-40px); }
        #loading-screen::after { opacity: 0.25; transform: translateY(80px) scale(1.2); }

        .loader { 
            border: 3px solid rgba(255, 255, 255, 0.12);
            border-top: 3px solid var(--gold-300);
            border-radius: 50%; width: 52px; height: 52px;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 20px rgba(216, 181, 108, 0.35);
        }

        .loading-title {
            font-size: 28px;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: var(--gold-200);
        }

        .loading-text {
            font-family: "Be Vietnam Pro", sans-serif;
            font-size: 11px; letter-spacing: 0.3em; text-transform: uppercase;
            color: rgba(242, 214, 163, 0.85);
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @keyframes floatGlow {
            0% { transform: translateY(0) scale(1); opacity: 0.5; }
            50% { transform: translateY(-18px) scale(1.03); opacity: 0.85; }
            100% { transform: translateY(0) scale(1); opacity: 0.5; }
        }

        @keyframes fadeDown {
            from { opacity: 0; transform: translate(-50%, -16px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        @keyframes heartFloat {
            0% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }

        @keyframes collagePop {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        @keyframes fanPop {
            from { opacity: 0; transform: translate(-50%, -50%) rotate(var(--angle, 0deg)) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) rotate(var(--angle, 0deg)) scale(1); }
        }

        #cam-feedback {
            position: absolute; bottom: 20px; left: 20px; width: 120px; height: 90px;
            transform: scaleX(-1);
            border: 1px solid rgba(247, 227, 189, 0.75);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.35), inset 0 0 0 2px rgba(255, 255, 255, 0.08);
            border-radius: 14px; opacity: 0.75; z-index: 100;
            background: linear-gradient(135deg, rgba(255, 247, 238, 0.12), rgba(63, 18, 24, 0.25));
        }

        #ai-status {
            position: absolute; bottom: 118px; left: 20px; 
            width: 180px; text-align: left;
            color: var(--gold-300); font-family: "Be Vietnam Pro", sans-serif;
            font-size: 11px; letter-spacing: 0.08em; font-weight: 500;
            z-index: 100; text-shadow: 0 0 6px rgba(0, 0, 0, 0.5);
            pointer-events: none; opacity: 0.9;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(216, 181, 108, 0.45);
            background: rgba(12, 4, 6, 0.55);
            display: inline-block;
        }

        /* --- MAGIC LOCK STYLES --- */
        #lock-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background:
                radial-gradient(circle at 50% 45%, rgba(90, 26, 34, 0.82) 0%, rgba(12, 4, 6, 0.96) 70%),
                linear-gradient(180deg, rgba(30, 10, 14, 0.85) 0%, rgba(7, 3, 4, 0.95) 100%);
            backdrop-filter: blur(8px);
            z-index: 9000;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 2s ease-in-out, visibility 2s;
            pointer-events: none; 
            overflow: hidden;
        }

        #lock-overlay::before,
        #lock-overlay::after {
            content: "";
            position: absolute;
            border-radius: 50%;
            border: 1px solid rgba(216, 181, 108, 0.35);
            box-shadow: 0 0 30px rgba(216, 181, 108, 0.25);
        }

        #lock-overlay::before { width: 360px; height: 360px; opacity: 0.6; }
        #lock-overlay::after { width: 520px; height: 520px; opacity: 0.25; border-style: dashed; }

        #lock-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }

        #heart-field {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 13;
        }

        #memory-stage {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 18px;
            pointer-events: auto;
            z-index: 12;
            opacity: 0;
            transition: opacity 1s ease;
            perspective: 900px;
            padding: 0 18px;
        }

        #memory-stage.is-visible { opacity: 1; }
        #memory-stage.is-focused {
            align-items: center;
            justify-content: flex-start;
            padding-top: 56px;
        }

        #heart-box {
            --heart-size: min(260px, 60vw);
            position: relative;
            width: calc(var(--heart-size) * 1.6);
            height: calc(var(--heart-size) * 1.4);
            transform-style: preserve-3d;
            animation: heartFloat 6s ease-in-out infinite;
            filter: drop-shadow(0 20px 40px rgba(0, 0, 0, 0.35));
        }

        #memory-stage.is-focused #heart-box {
            transform: translateY(-30px);
        }

        #heart-box::after {
            content: "";
            position: absolute;
            inset: -25%;
            background: radial-gradient(circle, rgba(255, 189, 210, 0.4) 0%, rgba(255, 189, 210, 0.08) 60%, transparent 70%);
            filter: blur(30px);
            opacity: 0.65;
            z-index: -1;
        }

        .heart-piece {
            position: absolute;
            width: var(--heart-size);
            height: var(--heart-size);
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            border-radius: 26px;
            background: linear-gradient(135deg, #b42a3b, #7a1724);
            box-shadow: inset 0 0 24px rgba(255, 255, 255, 0.12);
        }

        .heart-piece::before,
        .heart-piece::after {
            content: "";
            position: absolute;
            width: var(--heart-size);
            height: var(--heart-size);
            background: inherit;
            border-radius: 50%;
        }

        .heart-piece::before { top: calc(var(--heart-size) * -0.5); left: 0; }
        .heart-piece::after { left: calc(var(--heart-size) * 0.5); top: 0; }

        .heart-base {
            transform: translate(-50%, -32%) rotate(-45deg);
            background: linear-gradient(135deg, #8d1e2c, #5c121c);
            box-shadow: inset 0 0 35px rgba(0, 0, 0, 0.25);
            z-index: 1;
        }

        .heart-lid {
            transform-origin: 50% 60%;
            transform: translate(-50%, -64%) rotate(-45deg) rotateX(0deg);
            transition: transform 1.1s cubic-bezier(0.2, 0.8, 0.2, 1);
            background: linear-gradient(135deg, #d34a5f, #9c2434);
            z-index: 2;
        }

        #heart-box.open .heart-lid {
            transform: translate(-50%, -88%) rotate(-45deg) rotateX(65deg);
        }

        .heart-ribbon {
            position: absolute;
            width: 22px;
            height: 70%;
            left: 50%;
            top: 12%;
            transform: translateX(-50%);
            border-radius: 999px;
            background: linear-gradient(180deg, #f7e3bd, #e0b873);
            box-shadow: inset 0 0 8px rgba(255, 255, 255, 0.55);
            z-index: 3;
        }

        .heart-bow {
            position: absolute;
            top: 18%;
            left: 50%;
            width: 64px;
            height: 30px;
            transform: translateX(-50%);
            z-index: 4;
        }

        .heart-bow::before,
        .heart-bow::after {
            content: "";
            position: absolute;
            width: 32px;
            height: 24px;
            border-radius: 999px;
            border: 2px solid rgba(214, 176, 107, 0.95);
            background: linear-gradient(135deg, #f9e7c5, #d9b06c);
            box-shadow: inset 0 0 6px rgba(255, 255, 255, 0.6);
        }

        .heart-bow::before { left: 0; transform: rotate(-10deg); }
        .heart-bow::after { right: 0; transform: rotate(10deg); }

        .heart-bow span {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            background: #f7e3bd;
            box-shadow: inset 0 0 6px rgba(255, 255, 255, 0.6);
        }

        #chapter-photos {
            display: grid;
            justify-items: center;
            gap: 12px;
            padding: 16px 18px 20px;
            width: min(82vw, 420px);
            background: linear-gradient(140deg, rgba(255, 251, 245, 0.86), rgba(255, 230, 228, 0.8));
            border: 1px solid rgba(216, 181, 108, 0.6);
            border-radius: 20px;
            box-shadow: 0 14px 30px rgba(22, 8, 11, 0.35);
            backdrop-filter: blur(12px);
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        #chapter-photos.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        #chapter-photos.is-fan {
            width: min(88vw, 620px);
            padding: 18px 18px 22px;
        }

        #chapter-photos.is-collage {
            width: min(86vw, 640px);
            padding: 18px 18px 24px;
        }

        #chapter-photo-frame {
            width: min(70vw, 320px);
            background: #fff;
            padding: 10px 10px 18px;
            border-radius: 18px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.25);
        }

        #chapter-photo {
            width: 100%;
            aspect-ratio: 3 / 4;
            object-fit: cover;
            border-radius: 12px;
            display: block;
            opacity: 0;
            transform: scale(1.02);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        #chapter-photo.is-visible {
            opacity: 1;
            transform: scale(1);
        }

        #chapter-fan {
            display: none;
            position: relative;
            width: min(82vw, 560px);
            height: min(60vw, 360px);
        }

        #chapter-collage {
            display: none;
            position: relative;
            width: min(78vw, 520px);
            height: min(66vw, 460px);
        }

        #chapter-photos.is-fan #chapter-photo-frame { display: none; }
        #chapter-photos.is-fan #chapter-fan { display: block; }
        #chapter-photos.is-collage #chapter-photo-frame { display: none; }
        #chapter-photos.is-collage #chapter-collage { display: block; }

        .collage-photo {
            position: absolute;
            width: clamp(36px, 7.4vw, 64px);
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 10px;
            border: 3px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25);
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.9);
            animation: collagePop 0.6s ease forwards;
            animation-delay: var(--delay, 0ms);
        }

        .fan-photo {
            position: absolute;
            width: clamp(88px, 18vw, 150px);
            aspect-ratio: 3 / 4;
            object-fit: cover;
            border-radius: 14px;
            border: 6px solid #fff;
            border-bottom-width: 14px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.28);
            opacity: 0;
            transform: translate(-50%, -50%) rotate(var(--angle, 0deg)) scale(0.94);
            animation: fanPop 0.5s ease forwards;
        }

        .collage-center-text {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-family: "Cormorant Garamond", "Playfair Display", serif;
            font-size: clamp(18px, 3vw, 30px);
            letter-spacing: 0.14em;
            color: rgba(122, 36, 48, 0.9);
            text-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
            pointer-events: none;
        }

        .collage-letter {
            position: absolute;
            right: 4%;
            bottom: 4%;
            width: 54px;
            height: 54px;
            border-radius: 14px;
            border: 1px solid rgba(216, 181, 108, 0.6);
            background: rgba(255, 255, 255, 0.9);
            display: grid;
            place-items: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        .collage-letter svg {
            width: 34px;
            height: 26px;
        }

        .heart {
            position: absolute;
            bottom: -40px;
            width: 1em;
            height: 1em;
            background: linear-gradient(135deg, #ff5f7a, #ff9ab3);
            transform: translate(-50%, 0) rotate(45deg);
            opacity: 0;
            filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.35));
            animation: floatUp var(--dur, 5s) ease-out forwards;
            will-change: transform, opacity;
        }

        .heart::before,
        .heart::after {
            content: "";
            position: absolute;
            width: 1em;
            height: 1em;
            background: inherit;
            border-radius: 50%;
        }

        .heart::before { top: -0.5em; left: 0; }
        .heart::after { left: -0.5em; top: 0; }

        @keyframes floatUp {
            0% { opacity: 0; transform: translate(-50%, 0) rotate(45deg); }
            10% { opacity: 0.9; }
            100% { opacity: 0; transform: translate(calc(-50% + var(--x, 0px)), -120vh) rotate(45deg); }
        }

        #guide-text {
            position: absolute; top: 12%; left: 50%; transform: translateX(-50%);
            width: max-content; text-align: center;
            font-family: "Be Vietnam Pro", sans-serif;
            color: var(--gold-200); font-size: 12px; letter-spacing: 0.28em;
            text-transform: uppercase; opacity: 0.8;
            pointer-events: none;
            padding: 10px 26px;
            border-radius: 999px;
            border: 1px solid rgba(216, 181, 108, 0.7);
            background: linear-gradient(135deg, rgba(17, 6, 9, 0.7), rgba(83, 22, 30, 0.55));
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
            transition: opacity 0.5s;
            animation: pulseGuide 3s infinite ease-in-out;
        }

        @keyframes pulseGuide { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        @media (max-width: 720px) {
            #frame { inset: 10px; border-radius: 20px; }
            #ui { top: 14px; padding: 12px 20px 10px; }
            #ui .ui-title { font-size: 16px; letter-spacing: 0.14em; }
            #ui .ui-subtitle { font-size: 9px; letter-spacing: 0.16em; }
            .loading-title { font-size: 20px; letter-spacing: 0.12em; }
            #intro-card { padding: 22px 18px; }
            #subtitle-container { margin-top: 6px; }
            #subtitle { padding: 14px 22px; }
            #heart-box { --heart-size: min(210px, 70vw); }
            #chapter-photos {
                width: min(90vw, 320px);
                padding: 12px 14px 16px;
            }
            #chapter-photo-frame { width: min(78vw, 240px); padding: 8px 8px 14px; }
            #chapter-photos.is-collage {
                width: min(92vw, 480px);
                padding: 14px 14px 18px;
            }
            #chapter-photos.is-fan {
                width: min(94vw, 520px);
                padding: 14px 14px 18px;
            }
            #chapter-collage { width: min(86vw, 360px); height: min(78vw, 320px); }
            .collage-photo { width: clamp(30px, 9vw, 54px); }
            .collage-letter { width: 44px; height: 44px; }
            .collage-letter svg { width: 28px; height: 22px; }
            #chapter-fan { width: min(88vw, 420px); height: min(70vw, 300px); }
            .fan-photo { width: clamp(82px, 24vw, 130px); border-width: 5px; border-bottom-width: 12px; }
            #cam-feedback { width: 96px; height: 72px; }
            #ai-status { bottom: 108px; font-size: 9px; letter-spacing: 0.06em; }
        }

        @media (max-width: 520px) {
            body {
                font-size: 14px;
            }
            #frame { inset: 12px; }
            #ui {
                top: 12px;
                padding: 10px 18px 8px;
                gap: 4px;
            }
            #intro-card {
                width: min(96vw, 360px);
                padding: 18px 16px;
            }
            #letter-card {
                width: min(96vw, 360px);
                padding: 20px;
                max-height: none;
            }
            #guide-text {
                top: auto;
                bottom: 18px;
                left: 50%;
                transform: translate(-50%, 0);
                width: min(92vw, 280px);
                font-size: 11px;
                letter-spacing: 0.22em;
            }
            #memory-stage {
                padding: 0 12px 28px;
            }
            #chapter-photos {
                width: min(92vw, 360px);
                padding: 12px 14px 16px;
            }
            #chapter-photo-frame { width: min(80vw, 280px); }
            #chapter-photos.is-fan,
            #chapter-photos.is-collage {
                width: min(94vw, 360px);
            }
            #chapter-fan { width: min(92vw, 360px); height: min(80vw, 320px); }
            #chapter-collage { width: min(92vw, 360px); height: min(90vw, 340px); }
            #cam-feedback { width: 80px; height: 60px; right: 12px; left: auto; }
            #ai-status { bottom: 90px; right: 8px; left: auto; font-size: 10px; }
            .intro-actions { flex-direction: column; gap: 10px; }
            .intro-btn {
                width: 100%;
                min-width: unset;
                padding: 12px 0;
            }
        }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3"
            }
        }
    </script>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-title">Hợp Đồng Tình Yêu</div>
        <div class="loader"></div>
        <div class="loading-text">Đang gom kỷ niệm...</div>
    </div>

    <div id="intro-screen">
        <div id="intro-card">
            <div class="intro-eyebrow">Hợp đồng tình yêu</div>
            <h1>Hãy lựa chọn đáp án phù hợp nhất</h1>
            <p>Bạn có đồng ý kí thêm bản hợp đồng tình yêu lâu dài với người yêu hiện tại của bạn không?</p>
            <div class="intro-actions">
                <button class="intro-btn" id="intro-yes" type="button">Có</button>
                <button class="intro-btn" id="intro-no" type="button">Không</button>
            </div>
        </div>
    </div>

    <div id="letter-modal" aria-hidden="true">
        <div id="letter-card">
            <button id="letter-close" type="button" aria-label="Đóng">×</button>
            <div class="letter-header">
                <div class="letter-eyebrow">Lá thư kỷ niệm</div>
                <div class="letter-title">Tròn 1 năm bên nhau</div>
                <div class="letter-divider"></div>
            </div>
            <div class="letter-body">
                <p><strong>Vợ ơi,</strong></p>
                <p>Vậy là vợ chồng mình <strong>tròn 1 năm</strong> rồi đó. Chồng ngồi viết mà vừa nghiêm túc vừa buồn cười… vì mới ngày nào chồng còn <strong>run run e thẹn nắm tay vợ đi dạo quanh Bảo tàng Quân sự Việt Nam</strong>, cứ như nắm tay “nữ thần” chứ không phải nắm tay người yêu. Vậy mà giờ chồng đã quen với đặc quyền cao cấp nhất đời mình: <strong>được vợ ôm</strong>… và được vợ <strong>nhắc nhở/cằn nhằn</strong> đủ thứ từ ăn uống, ngủ nghỉ, ăn mặc. Đúng kiểu “hậu phương vững chắc” của chồng luôn.</p>
                <p>Một năm qua, vợ chồng mình đi qua nhiều nơi — và cũng đi qua đủ mọi “địa hình” trong tình yêu: mình <strong>cãi nhau nhiều lần</strong>, có lúc <strong>dừng lại</strong>, rồi lại <strong>tiếp tục yêu</strong>, có lúc căng đến mức còn <strong>báo cả phụ huynh</strong>. Nghe thì mệt, nhưng nhìn lại chồng lại thấy… tụi mình yêu thật nên mới vậy. Yêu thật nên mới đau thật, mới nghĩ nhiều, mới cố mà đi tiếp.</p>
                <p>Chồng biết vợ chồng mình đã làm nhau buồn không ít. Nhưng mình cũng làm nhau vui rất nhiều. Và điều khiến chồng nhớ nhất là vợ đã chăm chồng <strong>từng li từng tí</strong>: lo lắng, nhường nhịn, để ý những chuyện nhỏ xíu mà chồng hay bỏ qua. Có những lúc chồng thấy vợ giống như <strong>người mẹ thứ hai</strong> của chồng vậy… chỉ khác cái là mẹ nói một lần, còn vợ nói một lần rồi… <strong>nhắc thêm vài lần cho chắc</strong>.</p>
                <p>Vợ à, chồng cũng phải nói thật: vợ <strong>cứng đầu</strong> kinh khủng. Nhiều lúc chồng bất lực luôn, kiểu “chồng thua, chồng xin rút lui.” Nhưng chồng hiểu, chính cái cứng đầu đó là phần làm vợ mạnh mẽ, là cái khiến vợ không dễ buông bỏ. Và cũng vì vậy mà vợ mới thương chồng theo kiểu rất “vợ”: có thể giận, có thể khóc, nhưng vẫn không nỡ bỏ chồng một mình.</p>
                <p>Mà vợ còn <strong>mít ướt</strong> nữa. Dễ khóc, hay <strong>ovtk</strong>. Có lúc vợ khóc vì vợ buồn. Có lúc vợ lại khóc chỉ vì thấy <strong>chồng buồn</strong>, chồng mệt. Chồng nhớ những lần vợ không ngại mệt mà lên chơi với chồng, dù biết vợ cũng áp lực đủ thứ:</p>
                <ul>
                    <li><strong>Bố mẹ vợ còn chưa mở lòng với chồng</strong>.</li>
                    <li><strong>Khoảng cách 310km từ Nghệ An đến Hà Nội</strong>.</li>
                    <li>Lên Hà Nội rồi, trọ chồng vẫn <strong>xa nhà vợ 12 cây</strong>.</li>
                </ul>
                <p>Vậy mà chồng vẫn thích lên gặp vợ. Vì chồng <strong>yêu</strong>, chồng <strong>nhớ</strong>, chồng <strong>muốn gặp</strong>. Và chồng thích nhất là được chở vợ về — để vợ ôm chồng từ phía sau. Cái ôm đó với chồng giống như được “sạc pin”: ấm, yên, và làm chồng thấy mình có nhà.</p>
                <p>Hôm nay, chồng muốn nói rõ ràng, nghiêm túc, không vòng vo:</p>
                <p><strong>Chồng yêu vợ. Chồng chọn vợ. Và chồng chỉ yêu một mình vợ thôi.</strong> Vợ đừng ovtk nữa, đừng nghĩ chồng sẽ đi với cô gái khác nữa. Chồng không cần ai khác để khiến tim chồng rung. Chồng chỉ cần vợ — người vừa làm chồng muốn sống tốt hơn, vừa làm chồng muốn cố gắng hơn mỗi ngày.</p>
                <p>Chồng mong vợ <strong>cười nhiều hơn</strong>. Mong vợ bớt khóc, bớt tự làm mình đau bằng những suy nghĩ không đáng. Mong vợ tin chồng — tin vào những gì chồng đang làm và tin vào điều quan trọng nhất: <strong>chồng vẫn ở đây, vẫn hướng về vợ, vẫn chọn vợ</strong>.</p>
                <p>Chồng không hứa tình yêu lúc nào cũng ngọt như phim, nhưng chồng hứa sẽ luôn <strong>ở lại</strong>, luôn <strong>nắm tay vợ</strong>, luôn <strong>cùng vợ giải quyết</strong>. Để sau này, bố mẹ vợ nhìn vào sẽ thấy: “Ừ, thằng này có thể chưa hoàn hảo, nhưng nó thương con mình thật.”</p>
                <p>Chúc mừng kỷ niệm 1 năm của vợ chồng mình. Cảm ơn vợ vì đã thương chồng, lo cho chồng, nhắc chồng, và vẫn chọn chồng dù chồng nhiều lúc vụng về.</p>
                <p>Thương vợ nhiều lắm.<br>Chồng của vợ</p>
                <p class="letter-sign">___MPV___</p>
            </div>
        </div>
    </div>

    <div id="lock-overlay">
        <canvas id="lock-canvas"></canvas>
        <div id="guide-text">Vẽ hình trái tim để mở khóa</div>
    </div>

    <div id="heart-field" aria-hidden="true"></div>
    <div id="frame" aria-hidden="true"></div>

    <div id="memory-stage" aria-hidden="true">
        <div id="heart-box">
            <div class="heart-lid heart-piece"></div>
            <div class="heart-base heart-piece"></div>
            <div class="heart-ribbon"></div>
            <div class="heart-bow"><span></span></div>
        </div>
        <div id="chapter-photos" aria-hidden="true">
            <div id="chapter-photo-frame">
                <img id="chapter-photo" alt="" loading="lazy" decoding="async">
            </div>
            <div id="chapter-fan" aria-hidden="true"></div>
            <div id="chapter-collage" aria-hidden="true"></div>
        </div>
        <div id="subtitle-container">
            <div id="subtitle">
                <div id="chapter-kicker"></div>
                <div id="chapter-title"></div>
                <div id="chapter-line"></div>
            </div>
        </div>
    </div>

    <div id="vignette"></div>
    <div id="noise"></div>
    
    <video id="webcam" autoplay playsinline style="display:none;"></video>
    <canvas id="cam-feedback"></canvas> 
    <div id="ai-status">Sẵn sàng</div>

    <div id="ui">
        <div class="ui-subtitle large">Kỷ niệm 365 ngày bên nhau</div>
    </div>

    <div id="credit">__MPV with LOVE __</div>

    <script type="module">
        import { FilesetResolver, HandLandmarker } from "@mediapipe/tasks-vision";

        const PERF_CONFIG = { detectIntervalMs: 100 };
        const SEQUENCE_CONFIG = { photoWordMs: 1000, photoGapMs: 1200, chapterGapMs: 1200 };

        const subtitle = document.getElementById('subtitle');
        const chapterKicker = document.getElementById('chapter-kicker');
        const chapterTitle = document.getElementById('chapter-title');
        const chapterLine = document.getElementById('chapter-line');
        const chapterPhotos = document.getElementById('chapter-photos');
        const chapterPhoto = document.getElementById('chapter-photo');
        const chapterFan = document.getElementById('chapter-fan');
        const chapterCollage = document.getElementById('chapter-collage');
        const heartBox = document.getElementById('heart-box');
        const memoryStage = document.getElementById('memory-stage');
        const introScreen = document.getElementById('intro-screen');
        const introYes = document.getElementById('intro-yes');
        const introNo = document.getElementById('intro-no');
        const letterModal = document.getElementById('letter-modal');
        const letterClose = document.getElementById('letter-close');

        let sequenceTimeout = null;
        let sequenceResolver = null;
        let isSequenceRunning = false;
        let skipRequested = false;

        let handLandmarker = undefined;
        let webcamRunning = false;
        let lastGesture = "NONE";
        let latestLandmarks = null;

        const video = document.getElementById("webcam");
        const canvasElement = document.getElementById("cam-feedback");
        const canvasCtx = canvasElement.getContext("2d");
        const aiStatus = document.getElementById("ai-status");
        canvasElement.width = 120;
        canvasElement.height = 90;

        const STORY_PART_1 = "Lần đầu tặng quà cho nhau và lần đầu đi date với nhau";
        const STORY_PART_2 = "Bin ghét yêu xa và Na cũng vậy, Lần đầu chạy hơn 100km để tìm em, Anh vẫn run khi gặp em, Rồi anh nhận được món quà là một chậu hoa lego, Em thì nhận dc bó hoa anh tự gói";
        const STORY_PART_3 = "Rồi tụi mình đi PhotoBooth, Về tan ngồi Cf em còn bảo anh đểu cáng k đáng tin, Rồi mình cũng đã yêu nhau được hơn 1 năm, Cảm ơn em vì tất cả, Mãi bên anh em nhé";
        const STORY_PART_4 = "Những lần đi photoboot với nhau";
        const STORY_PART_5 = "sinh nhật 2 đứa";
        const STORY_PART_6 = "những ngày kỉ niệm";
        const STORY_PART_7 = "Những Buổi Đi Chơi Cùng Nhau";

        const STORIES = [
            { title: "Lần Đầu", lyricsRaw: STORY_PART_1, folder: "chuong1", imageCount: 8, imageExt: "jpg" },
            { title: "Lần đầu đi chơi đêm", lyricsRaw: STORY_PART_2, folder: "chuong2", imageCount: 5, imageExt: "jpg" },
            { title: "Ngày Lễ Tình Yêu Cùng Nhau", lyricsRaw: STORY_PART_3, folder: "chuong3", imageCount: 7, imageExt: "jpg" },
            { title: "Những lần đi photoboot với nhau", lyricsRaw: STORY_PART_4, folder: "chuong4", imageCount: 12, imageExt: "jpg" },
            { title: "sinh nhật 2 đứa", lyricsRaw: STORY_PART_5, folder: "chuong5", imageCount: 4, imageExt: "jpg" },
            { title: "những ngày kỉ niệm", lyricsRaw: STORY_PART_6, folder: "chuong6", imageCount: 8, imageExt: "jpg" },
            {
                title: "Chuyến Đi Chơi Cùng Nhau",
                lyricsRaw: STORY_PART_7,
                folder: "chuong7",
                imageCount: 37,
                imageExt: "jpg",
                extraImages: [
                    "Ảnh/z7392932474393_46c43e7deac049ab050f9b5d36315b60.jpg",
                    "Ảnh/z7392932508551_a36b665d387f7c01d91c7cc634744ce7.jpg",
                    "Ảnh/z7392932545602_e24e57b24bed86d8df961013098c0aeb.jpg",
                    "Ảnh/z7392932574056_24ebc7d1de91901faf6ee14c050ca1ee.jpg"
                ]
            }
        ];

        const PHOTO_MESSAGES = [
            [
                "Lần đầu tặng quà cho nhau",
                "Lần đầu tặng quà cho nhau",
                "Lần đầu cùng tổ chức sinh nhật cho bạn",
                "Lần đầu đi date cùng có 1 chút ngại ngùng, e thẹn. Vì lần đầu đi date, cũng như lần đầu nắm tay cậu và sau đó....",
                "Lần đầu đi date cùng có 1 chút ngại ngùng, e thẹn. Vì lần đầu đi date, cũng như lần đầu nắm tay cậu và sau đó....",
                "Lần đầu đi date cùng có 1 chút ngại ngùng, e thẹn. Vì lần đầu đi date, cũng như lần đầu nắm tay cậu và sau đó....",
                "Lần đầu đi date cùng có 1 chút ngại ngùng, e thẹn. Vì lần đầu đi date, cũng như lần đầu nắm tay cậu và sau đó....",
                "Lần đầu đi date cùng có 1 chút ngại ngùng, e thẹn. Vì lần đầu đi date, cũng như lần đầu nắm tay cậu và sau đó...."
            ], // Chương 1
            [
                "Không lên kế hoạch trước chỉ vì nhớ quá nên phóng 310km từ quê ra",
                "Tuy chỉ gặp đc vỏn vẹn từ 10h sáng đến 8h tối",
                "Lúc gần phải về quê thì nỗi nhớ càng lớn",
                "Vì những thứ cậu làm cho tớ càng khiến tớ yêu cậu nhiều hơn",
                "Lúc này vẫn rất rất cảm động và rất yêu cậu"
            ], // Chương 2
            [
                "Buổi đi chơi đầu tiên sau khi bọn mình bước vào một mối quan hệ nghiêm túc, lúc đấy tớ muốn tạo ra ấn tượng và 1 sự bất ngờ cho cậu nên tớ đã dùng hết chất sám tung hết mọi hoa tay, lời văn và sự tinh tế để làm ra món quà ấy và bọn mình cũng đã có bức tượng tô chung đầu tiên.",
                "Buổi đi chơi đầu tiên sau khi bọn mình bước vào một mối quan hệ nghiêm túc, lúc đấy tớ muốn tạo ra ấn tượng và 1 sự bất ngờ cho cậu nên tớ đã dùng hết chất sám tung hết mọi hoa tay, lời văn và sự tinh tế để làm ra món quà ấy và bọn mình cũng đã có bức tượng tô chung đầu tiên.",
                "Buổi đi chơi đầu tiên sau khi bọn mình bước vào một mối quan hệ nghiêm túc, lúc đấy tớ muốn tạo ra ấn tượng và 1 sự bất ngờ cho cậu nên tớ đã dùng hết chất sám tung hết mọi hoa tay, lời văn và sự tinh tế để làm ra món quà ấy và bọn mình cũng đã có bức tượng tô chung đầu tiên.",
                "Lúc này là cũng một bất ngờ rất lớn mà cậu dành cho tớ, tớ mọi thứ như đang quá vui đối vs tớ vì cx là lần đầu tiên tớ đc nhận quà từ ngày lễ tình yêu từ 1 người con gái mà tớ rất thích và yêu nên lúc đấy trong tớ cảm thấy uầy thành tích lớn nhất trong cuộc đời mình đây rồi.",
                "Lúc này là cũng một bất ngờ rất lớn mà cậu dành cho tớ, tớ mọi thứ như đang quá vui đối vs tớ vì cx là lần đầu tiên tớ đc nhận quà từ ngày lễ tình yêu từ 1 người con gái mà tớ rất thích và yêu nên lúc đấy trong tớ cảm thấy uầy thành tích lớn nhất trong cuộc đời mình đây rồi.",
                "Lúc này là cũng một bất ngờ rất lớn mà cậu dành cho tớ, tớ mọi thứ như đang quá vui đối vs tớ vì cx là lần đầu tiên tớ đc nhận quà từ ngày lễ tình yêu từ 1 người con gái mà tớ rất thích và yêu nên lúc đấy trong tớ cảm thấy uầy thành tích lớn nhất trong cuộc đời mình đây rồi.",
                "Buổi đi chơi đầu tiên sau khi bọn mình bước vào một mối quan hệ nghiêm túc, lúc đấy tớ muốn tạo ra ấn tượng và 1 sự bất ngờ cho cậu nên tớ đã dùng hết chất sám tung hết mọi hoa tay, lời văn và sự tinh tế để làm ra món quà ấy và bọn mình cũng đã có bức tượng tô chung đầu tiên."
            ], // Chương 3
            [
                "Đây là lần đầu tiên bọn mình rủ nhau cùng đi chụp photobooth, cx hơi hồi hộp nma may là hình vẫn đẹp chắc tại mẫu xịn :>>>",
                "Đây là lần đầu tiên bọn mình rủ nhau cùng đi chụp photobooth, cx hơi hồi hộp nma may là hình vẫn đẹp chắc tại mẫu xịn :>>>",
                "Đây là lần đầu tiên bọn mình rủ nhau cùng đi chụp photobooth, cx hơi hồi hộp nma may là hình vẫn đẹp chắc tại mẫu xịn :>>>",
                "Đây là lần đầu tiên bọn mình rủ nhau cùng đi chụp photobooth, cx hơi hồi hộp nma may là hình vẫn đẹp chắc tại mẫu xịn :>>>",
                "Đây là lần thứ 2 cx là ngày sinh nhật tớ.",
                "Đây là lần thứ 2 cx là ngày sinh nhật tớ.",
                "Đây là lần thứ 4, một lần đi dạo ở triển lãm quân sự thì tìm ra được (May Thật!).",
                "Đây là lần thứ 4, một lần đi dạo ở triển lãm quân sự thì tìm ra được (May Thật!).",
                "Đây là lần thứ 4, một lần đi dạo ở triển lãm quân sự thì tìm ra được (May Thật!).",
                "Đây là lần thứ 3 ở ngay tại PTIT cũng là 1 lần chụp vội nhưng mà được cái ảnh đẹp.",
                "Đây là lần thứ 3 ở ngay tại PTIT cũng là 1 lần chụp vội nhưng mà được cái ảnh đẹp.",
                "Đây là lần thứ 3 ở ngay tại PTIT cũng là 1 lần chụp vội nhưng mà được cái ảnh đẹp."
            ], // Chương 4
            [
                "Ngày 14/3 ngày sinh nhật người bạn gái của tớ.",
                "Ngày 14/3 ngày sinh nhật người bạn gái của tớ.",
                "Ngày 1/5 cảm ơn cậu vì đã tổ chức sinh nhật cho tớ và tặng cho tớ 1 món quà thật đặc biệt",
                "Ngày 1/5 cảm ơn cậu vì đã tổ chức sinh nhật cho tớ và tặng cho tớ 1 món quà thật đặc biệt"
            ], // Chương 5
            [
                "Ngày đi chơi 8/3 mà tớ giành cho cậu",
                "Ngày đi chơi 8/3 mà tớ giành cho cậu",
                "Ngày đi chơi 8/3 mà tớ giành cho cậu",
                "Lần đầu đi hiến máu đôi.",
                "Lần đầu đi hiến máu đôi.",
                "Boy Day mà cậu cbi cho tớ.",
                "Tròn 100 ngày yêu nhau.",
                "Đi chơi 20/10 lại thôi nàoooo...!"
            ], // Chương 6
            [
                "Những chuyến đi chơi cùng nhau khiến mỗi đoạn đường như hát.",
                "Ngồi bên nhau dưới ánh nắng, cười nói về những chuyện nhỏ xíu và ước mơ lớn.",
                "Những lần dạo phố, cùng nhau lạc vào những góc nhỏ của Hà Nội.",
                "Anh luôn nhớ những lần tay trong tay, quên hết mệt mỏi để chỉ thấy yêu thương."
            ]
        ];

        const HeartField = {
            container: null,
            timer: null,
            init() {
                this.container = document.getElementById('heart-field');
            },
            start() {
                if (!this.container || this.timer) return;
                this.spawn();
                this.timer = setInterval(() => this.spawn(), 420);
            },
            spawn() {
                const heart = document.createElement('div');
                const size = 12 + Math.random() * 16;
                const hue = 335 + Math.random() * 20;
                const duration = 4 + Math.random() * 3;
                heart.className = 'heart';
                heart.style.left = `${20 + Math.random() * 60}%`;
                heart.style.fontSize = `${size}px`;
                heart.style.background = `hsl(${hue}, 80%, 65%)`;
                heart.style.setProperty('--dur', `${duration}s`);
                heart.style.setProperty('--x', `${(Math.random() * 2 - 1) * 120}px`);
                this.container.appendChild(heart);
                setTimeout(() => heart.remove(), duration * 1000 + 800);
            }
        };

        const MagicLock = {
            config: {
                smoothFactor: 0.15, orbitSpeed: 0, pulseSpeed: 2, activePulseSpeed: 5,
                colors: { primary: '#ffd700', dim: 'rgba(100, 100, 100, 0.4)', trailStart: 'rgba(255, 215, 0, 0)', trailEnd: 'rgba(255, 250, 220, 0.9)' }
            },
            isLocked: true,
            isSequenceActive: false,
            canvas: null, ctx: null,
            points: [
                { x: 0.5, y: 0.22 },
                { x: 0.42, y: 0.16 },
                { x: 0.32, y: 0.18 },
                { x: 0.22, y: 0.3 },
                { x: 0.2, y: 0.46 },
                { x: 0.28, y: 0.6 },
                { x: 0.4, y: 0.7 },
                { x: 0.5, y: 0.82 },
                { x: 0.6, y: 0.7 },
                { x: 0.72, y: 0.6 },
                { x: 0.8, y: 0.46 },
                { x: 0.78, y: 0.3 },
                { x: 0.68, y: 0.18 },
                { x: 0.58, y: 0.16 },
                { x: 0.5, y: 0.22 }
            ],
            currentIndex: 0,
            trail: [], particles: [], connectedPairs: [],
            cursor: { x: 0, y: 0 }, target: { x: 0, y: 0 },

            init() {
                this.canvas = document.getElementById('lock-canvas');
                if(!this.canvas) return;
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.cursor.x = window.innerWidth / 2;
                this.cursor.y = window.innerHeight / 2;
            },
            resize() {
                if(this.canvas) { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; }
            },
            update(landmarks) {
                if (!this.ctx || (!this.isLocked && !this.isSequenceActive)) return;
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                const time = Date.now();
                const rotationAngle = time * this.config.orbitSpeed;

                if (landmarks && !this.isSequenceActive && this.isLocked) {
                    const indexTip = landmarks[8];
                    this.target.x = (1 - indexTip.x) * this.canvas.width;
                    this.target.y = indexTip.y * this.canvas.height;
                    this.cursor.x += (this.target.x - this.cursor.x) * this.config.smoothFactor;
                    this.cursor.y += (this.target.y - this.cursor.y) * this.config.smoothFactor;
                    this.trail.push({ x: this.cursor.x, y: this.cursor.y });
                    if (this.trail.length > 25) this.trail.shift();
                }

                this.drawTrail();
                this.drawParticles();
                const realPoints = this.points.map(pt => this.getRotatedPoint(pt, rotationAngle));
                this.drawConnections(realPoints);

                realPoints.forEach((pos, idx) => {
                    const isActive = idx < this.currentIndex || this.isSequenceActive;
                    this.drawRune(pos.x, pos.y, isActive, time);
                    if (!this.isSequenceActive && idx === this.currentIndex && this.isLocked) {
                        const dist = Math.hypot(this.cursor.x - pos.x, this.cursor.y - pos.y);
                        if (dist < 85) {
                            this.spawnExplosion(pos.x, pos.y);
                            if (this.currentIndex > 0) this.connectedPairs.push({ from: this.currentIndex - 1, to: this.currentIndex });
                            this.currentIndex++;
                            if (this.currentIndex >= this.points.length) this.triggerUnlock();
                        }
                    }
                });
            },
            drawTrail() {
                if (this.trail.length < 2) return;
                const ctx = this.ctx; ctx.beginPath(); ctx.moveTo(this.trail[0].x, this.trail[0].y);
                for (let i = 1; i < this.trail.length - 2; i++) {
                    const xc = (this.trail[i].x + this.trail[i+1].x) / 2;
                    const yc = (this.trail[i].y + this.trail[i+1].y) / 2;
                    ctx.quadraticCurveTo(this.trail[i].x, this.trail[i].y, xc, yc);
                }
                ctx.quadraticCurveTo(this.trail[this.trail.length-2].x, this.trail[this.trail.length-2].y, this.trail[this.trail.length-1].x, this.trail[this.trail.length-1].y);
                const grad = ctx.createLinearGradient(this.trail[0].x, this.trail[0].y, this.cursor.x, this.cursor.y);
                grad.addColorStop(0, this.config.colors.trailStart); grad.addColorStop(1, this.config.colors.trailEnd);
                ctx.strokeStyle = grad; ctx.lineWidth = 5; ctx.lineCap = "round"; ctx.lineJoin = "round"; ctx.stroke();
            },
            drawConnections(realPoints) {
                const ctx = this.ctx;
                this.connectedPairs.forEach(pair => {
                    const p1 = realPoints[pair.from]; const p2 = realPoints[pair.to];
                    ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
                    ctx.strokeStyle = this.isSequenceActive ? '#ffd700' : 'rgba(255, 215, 0, 0.8)';
                    ctx.lineWidth = this.isSequenceActive ? 5 : 3;
                    if (this.isSequenceActive) { ctx.shadowBlur = 15; ctx.shadowColor = "#ffd700"; }
                    ctx.stroke(); ctx.shadowBlur = 0;
                });
            },
            drawRune(x, y, isActive, time) {
                const ctx = this.ctx; const baseSize = isActive ? 22 : 15;
                const color = isActive ? this.config.colors.primary : this.config.colors.dim;
                const scale = 1 + Math.sin(time * 0.001 * (isActive ? this.config.activePulseSpeed : this.config.pulseSpeed)) * (isActive ? 0.15 : 0.08);
                ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
                if (isActive) { ctx.shadowBlur = 20; ctx.shadowColor = color; }
                ctx.beginPath(); ctx.arc(0, 0, baseSize * 1.3, 0, Math.PI * 2); ctx.strokeStyle = color; ctx.lineWidth = 1; ctx.stroke();
                ctx.save(); ctx.rotate(-time * 0.0005); ctx.beginPath(); ctx.arc(0, 0, baseSize * 1.1, 0, Math.PI * 2); ctx.strokeStyle = color; ctx.setLineDash([2, 6]); ctx.lineWidth = 1.5; ctx.stroke(); ctx.restore();
                ctx.rotate(time * 0.001 * (isActive ? 2 : 0.5));
                const r = baseSize;
                const drawTri = (offset) => {
                    ctx.beginPath();
                    for(let i=0; i<3; i++) { const a = offset + (i * 120 * Math.PI/180); const tx = r * Math.cos(a); const ty = r * Math.sin(a); if(i===0) ctx.moveTo(tx, ty); else ctx.lineTo(tx, ty); }
                    ctx.closePath(); ctx.strokeStyle = color; ctx.lineWidth = 1.5; ctx.stroke();
                };
                drawTri(0); drawTri(Math.PI);
                ctx.beginPath(); ctx.arc(0, 0, 3, 0, Math.PI * 2); ctx.fillStyle = isActive ? '#fff' : color; ctx.fill(); ctx.restore();
            },
            spawnExplosion(x, y) {
                for (let i = 0; i < 40; i++) {
                    const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 4 + 1;
                    this.particles.push({ x, y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, life: 1.0, color: Math.random() > 0.4 ? '#ffd700' : '#ffffff' });
                }
            },
            drawParticles() {
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.03; p.vx *= 0.95; p.vy *= 0.95;
                    if (p.life <= 0) { this.particles.splice(i, 1); }
                    else {
                        this.ctx.beginPath(); this.ctx.arc(p.x, p.y, 3 * p.life, 0, Math.PI * 2);
                        this.ctx.fillStyle = p.color; this.ctx.globalAlpha = p.life; this.ctx.fill(); this.ctx.globalAlpha = 1.0;
                    }
                }
            },
            getRotatedPoint(pt, angle) {
                const cx = 0.5; const cy = 0.5; const x = pt.x - cx; const y = pt.y - cy;
                const cos = Math.cos(angle); const sin = Math.sin(angle);
                return { x: ((x * cos - y * sin) + cx) * this.canvas.width, y: ((x * sin + y * cos) + cy) * this.canvas.height };
            },
            triggerUnlock() {
                this.isLocked = true;
                this.isSequenceActive = true;
                document.getElementById('guide-text').style.opacity = 0;
                setTimeout(() => {
                    this.isLocked = false;
                    this.isSequenceActive = false;
                    HeartField.start();
                    heartBox.classList.remove('open');
                    memoryStage.classList.add('is-visible');
                    setStatus("Sẵn sàng");
                    const overlay = document.getElementById('lock-overlay');
                    overlay.style.opacity = 0;
                    setTimeout(() => { overlay.style.display = 'none'; }, 2000);
                }, 900);
            }
        };

        init();

        async function init() {
            HeartField.init();
            MagicLock.init();
            setSubtitleVisible(false);
            setupIntro();
            setupLetterModal();
            await setupAI();
            animate();
        }

        function setupIntro() {
            if (!introScreen || !introYes || !introNo) return;
            const yesLabel = introYes.textContent || "Có";
            const noLabel = introNo.textContent || "Không";
            let swapped = false;
            const acceptIntro = () => {
                introScreen.classList.add('is-hidden');
                setTimeout(() => introScreen.remove(), 700);
            };
            const swapLabels = () => {
                swapped = true;
                introNo.textContent = yesLabel;
                introYes.textContent = noLabel;
            };
            const resetLabels = () => {
                swapped = false;
                introNo.textContent = noLabel;
                introYes.textContent = yesLabel;
            };

            introYes.addEventListener('click', acceptIntro);
            introNo.addEventListener('click', acceptIntro);
            introNo.addEventListener('mouseenter', swapLabels);
            introNo.addEventListener('mouseleave', resetLabels);
            introNo.addEventListener('focus', swapLabels);
            introNo.addEventListener('blur', resetLabels);
        }

        function setupLetterModal() {
            if (!letterModal || !letterClose) return;
            const closeModal = () => {
                letterModal.classList.remove('is-visible');
                letterModal.setAttribute('aria-hidden', 'true');
            };
            letterClose.addEventListener('click', closeModal);
            letterModal.addEventListener('click', (event) => {
                if (event.target === letterModal) closeModal();
            });
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') closeModal();
            });
        }

        async function setupAI() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, delegate: "GPU" },
                runningMode: "VIDEO", numHands: 1
            });
            const constraints = { video: { width: { ideal: 640 }, height: { ideal: 360 } } };
            navigator.mediaDevices.getUserMedia(constraints).then((stream) => {
                video.srcObject = stream;
                video.addEventListener("loadeddata", () => {
                    webcamRunning = true;
                    document.getElementById('loading-screen').style.opacity = 0;
                    setTimeout(() => document.getElementById('loading-screen').remove(), 1000);
                    predictWebcam();
                });
            });
        }

        function animate() {
            MagicLock.update(latestLandmarks);
            requestAnimationFrame(animate);
        }

        let lastVideoTime = -1;
        let lastDetectTime = 0;
        function predictWebcam() {
            if (!handLandmarker || !webcamRunning) return;
            const now = performance.now();
            if (now - lastDetectTime < PERF_CONFIG.detectIntervalMs) {
                requestAnimationFrame(predictWebcam);
                return;
            }
            lastDetectTime = now;
            let startTimeMs = now;
            if (video.currentTime !== lastVideoTime) {
                lastVideoTime = video.currentTime;
                const results = handLandmarker.detectForVideo(video, startTimeMs);

                canvasCtx.save();
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                canvasCtx.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                canvasCtx.restore();

                if (results.landmarks && results.landmarks.length > 0) {
                    latestLandmarks = results.landmarks[0];
                    processGestures(latestLandmarks);
                } else {
                    latestLandmarks = null;
                    if (!MagicLock.isLocked && !isSequenceRunning) setStatus("Chờ tín hiệu tay...", "#f2d6a3");
                }
            }
            requestAnimationFrame(predictWebcam);
        }

        function processGestures(landmarks) {
            if (MagicLock.isLocked) return;

            const wrist = landmarks[0];
            const tips = [4, 8, 12, 16, 20];
            const extendedFingers = tips.filter(tip => {
                const dist = Math.sqrt(Math.pow(landmarks[tip].x - wrist.x, 2) + Math.pow(landmarks[tip].y - wrist.y, 2));
                return dist > 0.25; 
            }).length;

            let currentGesture = "NONE";
            const thumbIndexDist = Math.sqrt(Math.pow(landmarks[4].x - landmarks[8].x, 2) + Math.pow(landmarks[4].y - landmarks[8].y, 2));

            if (extendedFingers === 2 && thumbIndexDist > 0.08) currentGesture = "TWO";
            else if (thumbIndexDist < 0.05 && extendedFingers >= 2) currentGesture = "OK";
            else if (extendedFingers >= 4) currentGesture = "OPEN";
            else if (extendedFingers <= 1) currentGesture = "FIST";

            if (currentGesture !== lastGesture) {
                lastGesture = currentGesture;

                if (currentGesture === "OPEN") {
                    setStatus("🖐 Dừng", "#ff9aa7");
                    stopSequenceAndReset();
                } else if (currentGesture === "FIST") {
                    setStatus("✊ Bắt đầu", "#f7e3bd");
                    startAutoSequence();
                } else if (currentGesture === "OK") {
                    setStatus("👌 Bắt đầu", "#f7e3bd");
                    startAutoSequence();
                } else if (currentGesture === "TWO") {
                    setStatus("✌️ Nhanh", "#f7e3bd");
                    requestSkip();
                }
            }
        }

        function startAutoSequence() {
            if (isSequenceRunning) return;
            isSequenceRunning = true;
            memoryStage.classList.add('is-visible');
            memoryStage.classList.add('is-focused');
            heartBox.classList.add('open');
            setSubtitleVisible(true);
            setPhotosVisible(true);
            runChapterSequence(0);
        }

        function stopSequenceAndReset() {
            isSequenceRunning = false;
            clearDelay();
            skipRequested = false;
            heartBox.classList.remove('open');
            setSubtitleVisible(false);
            clearChapterPhotos();
            setPhotosVisible(false);
            memoryStage.classList.remove('is-focused');
            setStatus("Sẵn sàng");
        }

        async function runChapterSequence(chapterIdx) {
            if (!isSequenceRunning) return;
            const story = STORIES[chapterIdx];
            if (!story) return;

            setChapterHeader(chapterIdx, story.title);
            await playChapterPhotos(story, chapterIdx);
            if (!isSequenceRunning) return;

            if (chapterIdx < STORIES.length - 1) {
                await delay(SEQUENCE_CONFIG.chapterGapMs);
                runChapterSequence(chapterIdx + 1);
            } else {
                setStatus("END", "#f7e3bd");
                isSequenceRunning = false;
                memoryStage.classList.remove('is-focused');
            }
        }

        async function playChapterPhotos(story, chapterIdx) {
            if (!story || !story.imageCount) return;

            if (chapterIdx === 6) {
                showHeartCollage(story);
                await playCollageLines(story, chapterIdx);
                return;
            }

            const messages = normalizeMessages(getPhotoMessages(story, chapterIdx), story.imageCount);
            const groups = buildMessageGroups(messages);
            const imageExt = story.imageExt || "jpg";

            for (let groupIndex = 0; groupIndex < groups.length; groupIndex++) {
                if (!isSequenceRunning) return;
                const group = groups[groupIndex];
                const message = group.message || "";
                if (group.indices.length > 1) {
                    showFanPhotos(story, group.indices, imageExt);
                } else {
                    setChapterPhoto(story, group.indices[0], imageExt);
                }
                if (message) {
                    showLine(message);
                } else {
                    hideLine();
                    chapterLine.textContent = "";
                }
                const duration = Math.max(1, countWords(message)) * SEQUENCE_CONFIG.photoWordMs;
                await delay(duration);
                hideLine();
                if (!isSequenceRunning) return;
                if (groupIndex < groups.length - 1) await delay(SEQUENCE_CONFIG.photoGapMs);
            }
        }

        function getPhotoMessages(story, chapterIdx) {
            const custom = PHOTO_MESSAGES[chapterIdx] || [];
            if (custom.length > 0) return custom;
            return (story.lyricsRaw || "").split(',').map(s => s.trim()).filter(Boolean);
        }

        function buildMessageGroups(messages) {
            const groupMap = new Map();
            const order = [];
            messages.forEach((message, index) => {
                const key = message || "";
                if (!groupMap.has(key)) {
                    groupMap.set(key, []);
                    order.push(key);
                }
                groupMap.get(key).push(index);
            });
            return order.map((key) => ({ message: key, indices: groupMap.get(key) }));
        }

        function countWords(text) {
            return (text || "").trim().split(/\s+/).filter(Boolean).length;
        }

        async function playCollageLines(story, chapterIdx) {
            const lines = getPhotoMessages(story, chapterIdx).filter(Boolean);
            if (lines.length === 0) return;

            for (let i = 0; i < lines.length; i++) {
                if (!isSequenceRunning) return;
                showLine(lines[i]);
                const duration = Math.max(1, countWords(lines[i])) * SEQUENCE_CONFIG.photoWordMs;
                await delay(duration);
                hideLine();
                if (!isSequenceRunning) return;
                if (i < lines.length - 1) await delay(SEQUENCE_CONFIG.photoGapMs);
            }
        }

        function normalizeMessages(messages, count) {
            const result = [];
            const fallback = messages.length > 0 ? messages[messages.length - 1] : "";
            for (let i = 0; i < count; i++) {
                result.push(messages[i] || fallback || "");
            }
            return result;
        }

        function setChapterHeader(index, title) {
            chapterKicker.textContent = `Chương ${index + 1}`;
            chapterTitle.textContent = title || "";
        }

        function setSubtitleVisible(isVisible) {
            if (isVisible) {
                subtitle.classList.add('show');
                return;
            }
            subtitle.classList.remove('show');
            chapterKicker.textContent = "";
            chapterTitle.textContent = "";
            chapterLine.textContent = "";
            chapterLine.classList.remove('is-visible');
        }

        function setPhotosVisible(isVisible) {
            if (isVisible) {
                chapterPhotos.classList.add('is-visible');
                return;
            }
            chapterPhotos.classList.remove('is-visible');
        }

        function setFanMode(isFan) {
            if (isFan) {
                chapterPhotos.classList.add('is-fan');
                return;
            }
            chapterPhotos.classList.remove('is-fan');
        }

        function setCollageMode(isCollage) {
            if (isCollage) {
                chapterPhotos.classList.add('is-collage');
                return;
            }
            chapterPhotos.classList.remove('is-collage');
        }

        function clearChapterPhotos() {
            chapterPhoto.classList.remove('is-visible');
            chapterPhoto.removeAttribute('src');
            chapterPhoto.alt = "";
            chapterFan.innerHTML = "";
            chapterCollage.innerHTML = "";
            setFanMode(false);
            setCollageMode(false);
        }

        function setChapterPhoto(story, index, imageExt) {
            if (!story || !story.folder) return;
            setFanMode(false);
            setCollageMode(false);
            chapterPhoto.classList.remove('is-visible');
            const src = `${story.folder}/${index + 1}.${imageExt}`;
            chapterPhoto.src = src;
            chapterPhoto.alt = `${story.title || "Chapter"} ${index + 1}`;
            chapterPhoto.onload = () => {
                requestAnimationFrame(() => chapterPhoto.classList.add('is-visible'));
            };
            if (chapterPhoto.complete) {
                requestAnimationFrame(() => chapterPhoto.classList.add('is-visible'));
            }
        }

        function showFanPhotos(story, indices, imageExt) {
            if (!story || !story.folder || indices.length === 0) return;
            setFanMode(true);
            setCollageMode(false);
            chapterFan.innerHTML = "";

            const rect = chapterFan.getBoundingClientRect();
            const width = rect.width || 420;
            const height = rect.height || 300;
            const centerX = width / 2;
            const centerY = height * 0.84;
            const count = indices.length;
            const spread = Math.min(160, 50 + count * 8);
            const start = -spread / 2;
            const step = count > 1 ? spread / (count - 1) : 0;
            const radius = Math.min(width, height) * (0.46 + Math.min(count, 10) * 0.01);

            indices.forEach((index, pos) => {
                const img = document.createElement("img");
                img.src = `${story.folder}/${index + 1}.${imageExt}`;
                img.alt = `${story.title || "Chapter"} ${index + 1}`;
                img.loading = "lazy";
                img.decoding = "async";
                img.className = "fan-photo";
                const angle = start + (pos * step);
                const rad = (angle * Math.PI) / 180;
                const x = centerX + radius * Math.sin(rad);
                const y = centerY - radius * Math.cos(rad);
                img.style.left = `${(x / width) * 100}%`;
                img.style.top = `${(y / height) * 100}%`;
                img.style.setProperty("--angle", `${angle.toFixed(1)}deg`);
                img.style.zIndex = `${pos + 1}`;
                chapterFan.appendChild(img);
            });
        }

        function showHeartCollage(story) {
            const imageSources = buildChapterImageSources(story);
            if (!story || imageSources.length === 0) return;
            setFanMode(false);
            setCollageMode(true);
            chapterCollage.innerHTML = "";

            const positions = generateHeartPositions(imageSources.length);

            positions.forEach((pos, idx) => {
                const img = document.createElement("img");
                img.src = imageSources[idx] || "";
                img.alt = `${story.title || "Chapter"} ${idx + 1}`;
                img.loading = "lazy";
                img.decoding = "async";
                img.className = "collage-photo";
                img.style.left = `${pos.x * 100}%`;
                img.style.top = `${pos.y * 100}%`;
                img.style.setProperty("--delay", "0ms");
                img.style.transform = `translate(-50%, -50%) rotate(${(Math.random() * 12 - 6).toFixed(1)}deg)`;
                chapterCollage.appendChild(img);
            });

            const centerText = document.createElement("div");
            centerText.className = "collage-center-text";
            centerText.textContent = "I LOVE YOU";
            chapterCollage.appendChild(centerText);

            const letter = document.createElement("div");
            letter.className = "collage-letter";
            letter.innerHTML = `
                <svg viewBox="0 0 64 48" aria-hidden="true" focusable="false">
                    <rect x="6" y="8" width="52" height="32" rx="6" fill="rgba(248, 237, 220, 0.9)" stroke="rgba(122, 36, 48, 0.8)" stroke-width="2"/>
                    <path d="M8 12 L32 28 L56 12" fill="none" stroke="rgba(122, 36, 48, 0.8)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M10 36 L24 24" fill="none" stroke="rgba(122, 36, 48, 0.6)" stroke-width="2" stroke-linecap="round"/>
                    <path d="M54 36 L40 24" fill="none" stroke="rgba(122, 36, 48, 0.6)" stroke-width="2" stroke-linecap="round"/>
                    <path d="M32 22 c-3.6-4-9.6-3.2-11.2 0.4 c-1.4 3.2 0.8 6.6 4.2 8.4 l7 4.2 l7-4.2 c3.4-1.8 5.6-5.2 4.2-8.4 c-1.6-3.6-7.6-4.4-11.2-0.4z" fill="rgba(185, 42, 59, 0.85)"/>
                </svg>
            `;
            letter.addEventListener('click', () => {
                if (!letterModal) return;
                letterModal.classList.add('is-visible');
                letterModal.setAttribute('aria-hidden', 'false');
            });
            chapterCollage.appendChild(letter);
        }

        function generateHeartPositions(count) {
            const bounds = getHeartBounds();
            const padding = 0.08;
            const positions = [];
            for (let i = 0; i < count; i++) {
                const t = (i / count) * Math.PI * 2;
                const point = heartPoint(t);
                const nx = (point.x - bounds.minX) / (bounds.maxX - bounds.minX);
                const ny = 1 - (point.y - bounds.minY) / (bounds.maxY - bounds.minY);
                const x = padding + (1 - padding * 2) * nx;
                const y = padding + (1 - padding * 2) * ny;
                positions.push({ x, y });
            }
            return positions;
        }

        function heartPoint(t) {
            const x = 16 * Math.pow(Math.sin(t), 3);
            const y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
            return { x, y };
        }

        function getHeartBounds() {
            let minX = Infinity;
            let maxX = -Infinity;
            let minY = Infinity;
            let maxY = -Infinity;
            const samples = 200;
            for (let i = 0; i <= samples; i++) {
                const t = (i / samples) * Math.PI * 2;
                const point = heartPoint(t);
                minX = Math.min(minX, point.x);
                maxX = Math.max(maxX, point.x);
                minY = Math.min(minY, point.y);
                maxY = Math.max(maxY, point.y);
            }
            return { minX, maxX, minY, maxY };
        }

        function buildChapterImageSources(story) {
            if (!story) return [];
            const extras = Array.isArray(story.extraImages) ? story.extraImages : [];
            const folderCount = Math.max(0, (story.imageCount || 0) - extras.length);
            const imageExt = story.imageExt || "jpg";
            const sources = [];
            if (story.folder && folderCount > 0) {
                for (let i = 0; i < folderCount; i++) {
                    sources.push(`${story.folder}/${i + 1}.${imageExt}`);
                }
            }
            return sources.concat(extras);
        }

        function showLine(text) {
            if (!text) {
                hideLine();
                return;
            }
            chapterLine.classList.remove('is-visible');
            chapterLine.textContent = text;
            requestAnimationFrame(() => chapterLine.classList.add('is-visible'));
        }

        function hideLine() {
            chapterLine.classList.remove('is-visible');
        }

        function delay(ms) {
            return new Promise(resolve => {
                if (skipRequested) {
                    skipRequested = false;
                    resolve();
                    return;
                }
                sequenceResolver = resolve;
                sequenceTimeout = setTimeout(() => {
                    sequenceTimeout = null;
                    sequenceResolver = null;
                    resolve();
                }, ms);
            });
        }

        function clearDelay() {
            if (sequenceTimeout) {
                clearTimeout(sequenceTimeout);
                sequenceTimeout = null;
            }
            if (sequenceResolver) {
                sequenceResolver();
                sequenceResolver = null;
            }
        }

        function requestSkip() {
            if (!isSequenceRunning) return;
            skipRequested = true;
            clearDelay();
        }

        function setStatus(text, color = "#f2d6a3") {
            aiStatus.innerText = text;
            aiStatus.style.color = color;
        }
    </script>

</body>
</html>
